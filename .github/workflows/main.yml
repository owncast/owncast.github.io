name: Build and deploy to GitHub Pages

on:
  push:
    branches:
      - "owncast-docusaurus"
  schedule:
    # Every six hours update the web site
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: true # Fetch Hugo themes (true OR recursive)
          fetch-depth: 0 # Fetch all history for .GitInfo and .Lastmod
      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y jq build-essential libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev

      - name: Create static/data directory
        run: mkdir -p static/data

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "24.9.0"

      - name: Install npm dependencies
        run: npm install

      - name: Fetch All Contributors
        run: node scripts/fetch-contributors.js
        env:
          GH_ACCESS_TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}

      - name: Combine Contributors
        run: "jq -n 'input | . as $core | (input | . as $homepage | $core + $homepage) | unique_by(.login)' static/data/contributors-core.json static/data/contributors-homepage.json > static/data/contributors.json"

      - name: Fetch donors
        run: |
          CUTOFF_DATE=$(date -d '90 days ago' '+%Y-%m-%d')
          curl https://opencollective.com/owncast/members/all.json | jq --arg cutoff "$CUTOFF_DATE" 'map(.) | .[] | select(.role=="BACKER" and .lastTransactionAt >= $cutoff) | {login: .name, avatar_url: .image, html_url: .profile}' | jq --slurp '.' > static/data/donors.json

      - name: Process donors
        run: node scripts/process-donors.js

      - name: Generate releases pages
        run: node scripts/fetch-releases.js

      - name: Run preview generator
        working-directory: scripts/preview-generator
        run: |
          docker build -t owncast-installer-preview-generator .
          docker run --rm -v $PWD:/vhs owncast-installer-preview-generator ./installer.tape
          mv owncast-install.* ../../static/

      - name: Commit changes
        uses: EndBug/add-and-commit@v5
        with:
          author_name: Owncast
          author_email: owncast@owncast.online
          message: "Update dynamic content"
          add: "releases/ static/data/contributors.json static/data/donors.json static/data/contributors-processed.json static/data/donors-processed.json static/owncast-install.*"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload changed source files to Crowdin
        run: npm run crowdin:upload-existing
        env:
          CROWDIN_PERSONAL_TOKEN: ${{ secrets.CROWDIN_PERSONAL_TOKEN }}

      - name: Download Crowdin translations
        run: npm run crowdin:sync
        env:
          CROWDIN_PERSONAL_TOKEN: ${{ secrets.CROWDIN_PERSONAL_TOKEN }}

      - name: Build
        run: npm run build
        env:
          GH_ACCESS_TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}
      # - name: Deploy to surge
      #   uses: dswistowski/surge-sh-action@v1
      #   with:
      #     domain: owncast-preview.surge.sh
      #     project: ./build
      #     login: ${{ secrets.SURGE_LOGIN }}
      #     token: ${{ secrets.SURGE_TOKEN }}

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy ./build --project-name=owncast-docs-dev-testing

      # Deploy to DigitalOcean Spaces

      # Upload non-HTML assets (long cache)
      - name: Upload assets
        uses: jakejarvis/s3-sync-action@v0.5.1
        with:
          args: >
            --exclude "*.html"
            --cache-control "public, max-age=31536000, immutable"
        env:
          AWS_S3_BUCKET: ${{ vars.DO_SPACES_BUCKET }}
          AWS_ACCESS_KEY_ID: ${{ secrets.DO_SPACES_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.DO_SPACES_SECRET }}
          AWS_REGION: ${{ vars.DO_SPACES_REGION }}
          AWS_S3_ENDPOINT: https://${{ vars.DO_SPACES_REGION }}.digitaloceanspaces.com
          SOURCE_DIR: build

      # Upload HTML (short cache)
      - name: Upload HTML (short cache)
        uses: jakejarvis/s3-sync-action@v0.5.1
        with:
          args: >
            --exclude "*"
            --include "*.html"
            --cache-control "public, max-age=60"
        env:
          AWS_S3_BUCKET: ${{ secrets.DO_SPACES_BUCKET }}
          AWS_ACCESS_KEY_ID: ${{ secrets.DO_SPACES_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.DO_SPACES_SECRET }}
          AWS_REGION: ${{ secrets.DO_SPACES_REGION }}
          AWS_S3_ENDPOINT: https://${{ secrets.DO_SPACES_REGION }}.digitaloceanspaces.com
          SOURCE_DIR: build

      # Purge Fastly cache
      #
      # Recommended: soft purge so users get instant fresh content when needed,
      # while allowing Fastly to serve stale during revalidation.
      - name: Purge Fastly
        uses: yukukotani/fastly-purge-action@v1
        with:
          api-token: ${{ secrets.FASTLY_API_TOKEN }}
          service-id: ${{ secrets.FASTLY_SERVICE_ID }}
          target: surrogate-key
          keys: docs-html,docs-static
          soft: true

      # - name: Deploy
      #   uses: peaceiris/actions-gh-pages@v4
      #   with:
      #     github_token: ${{ secrets.GITHUB_TOKEN }}
      #     publish_dir: ./public
