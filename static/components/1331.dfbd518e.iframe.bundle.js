(self.webpackChunkowncast_web=self.webpackChunkowncast_web||[]).push([[1331],{"./components/video/OwncastPlayer/OwncastPlayer.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{OwncastPlayer:()=>OwncastPlayer});var jsx_runtime=__webpack_require__("./node_modules/next/dist/compiled/react/jsx-runtime.js"),react=__webpack_require__("./node_modules/next/dist/compiled/react/index.js"),es=__webpack_require__("./node_modules/recoil/es/index.js"),dist=__webpack_require__("./node_modules/react-hotkeys-hook/packages/react-hotkeys-hook/dist/index.js"),classnames=__webpack_require__("./node_modules/classnames/index.js"),classnames_default=__webpack_require__.n(classnames),react_error_boundary_esm=__webpack_require__("./node_modules/react-error-boundary/dist/react-error-boundary.esm.js"),video_es=__webpack_require__("./node_modules/video.js/dist/video.es.js"),injectStylesIntoStyleTag=__webpack_require__("./node_modules/@storybook/nextjs/node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js"),injectStylesIntoStyleTag_default=__webpack_require__.n(injectStylesIntoStyleTag),styleDomAPI=__webpack_require__("./node_modules/@storybook/nextjs/node_modules/style-loader/dist/runtime/styleDomAPI.js"),styleDomAPI_default=__webpack_require__.n(styleDomAPI),insertBySelector=__webpack_require__("./node_modules/@storybook/nextjs/node_modules/style-loader/dist/runtime/insertBySelector.js"),insertBySelector_default=__webpack_require__.n(insertBySelector),setAttributesWithoutAttributes=__webpack_require__("./node_modules/@storybook/nextjs/node_modules/style-loader/dist/runtime/setAttributesWithoutAttributes.js"),setAttributesWithoutAttributes_default=__webpack_require__.n(setAttributesWithoutAttributes),insertStyleElement=__webpack_require__("./node_modules/@storybook/nextjs/node_modules/style-loader/dist/runtime/insertStyleElement.js"),insertStyleElement_default=__webpack_require__.n(insertStyleElement),styleTagTransform=__webpack_require__("./node_modules/@storybook/nextjs/node_modules/style-loader/dist/runtime/styleTagTransform.js"),styleTagTransform_default=__webpack_require__.n(styleTagTransform),VideoJS_module=__webpack_require__("./node_modules/@storybook/nextjs/node_modules/css-loader/dist/cjs.js??ruleSet[1].rules[15].use[1]!./node_modules/postcss-loader/dist/cjs.js!./node_modules/resolve-url-loader/index.js!./node_modules/sass-loader/dist/cjs.js??ruleSet[1].rules[15].use[4]!./components/video/VideoJS/VideoJS.module.scss"),options={};options.styleTagTransform=styleTagTransform_default(),options.setAttributes=setAttributesWithoutAttributes_default(),options.insert=insertBySelector_default().bind(null,"head"),options.domAPI=styleDomAPI_default(),options.insertStyleElement=insertStyleElement_default();injectStylesIntoStyleTag_default()(VideoJS_module.A,options);const VideoJS_VideoJS_module=VideoJS_module.A&&VideoJS_module.A.locals?VideoJS_module.A.locals:void 0;var console=__webpack_require__("./node_modules/console-browserify/index.js");__webpack_require__("./node_modules/video.js/dist/video-js.css");const VideoJS=({options,onReady})=>{const videoRef=react.useRef(null),playerRef=react.useRef(null);return react.useEffect(()=>{if(!playerRef.current){const videoElement=videoRef.current,player=playerRef.current=(0,video_es.A)(videoElement,options,()=>(console.debug("player is ready"),onReady&&onReady(player,video_es.A)));player.autoplay(options.autoplay),player.src(options.sources)}},[options,videoRef]),react.useEffect(()=>{video_es.A.getPlayer(videoRef.current).on("xhr-hooks-ready",()=>{var _videojs_getPlayer_tech;null===(_videojs_getPlayer_tech=video_es.A.getPlayer(videoRef.current).tech({IWillNotUseThisInPlugins:!0}))||void 0===_videojs_getPlayer_tech||_videojs_getPlayer_tech.vhs.xhr.onRequest(o=>{const{uri}=o;let updatedURI=uri;if(o.uri.match("m3u8")){const u=uri.startsWith("http")?new URL(uri):new URL(uri,window.location.protocol+window.location.host),cachebuster=Math.random().toString(16).slice(2,8);u.searchParams.append("cachebust",cachebuster),updatedURI=u.toString()}return{...o,uri:updatedURI}})})},[]),(0,jsx_runtime.jsx)("div",{"data-vjs-player":!0,children:(0,jsx_runtime.jsx)("video",{ref:videoRef,className:`video-js vjs-big-play-centered vjs-show-big-play-button-on-pause ${VideoJS_VideoJS_module.player} vjs-owncast`})})};try{VideoJS.displayName="VideoJS",VideoJS.__docgenInfo={description:"",displayName:"VideoJS",props:{options:{defaultValue:null,description:"",name:"options",required:!0,type:{name:"any"}},onReady:{defaultValue:null,description:"",name:"onReady",required:!0,type:{name:"(player: Player, vjsInstance: typeof videojs) => void"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["components/video/VideoJS/VideoJS.tsx#VideoJS"]={docgenInfo:VideoJS.__docgenInfo,name:"VideoJS",path:"components/video/VideoJS/VideoJS.tsx#VideoJS"})}catch(__react_docgen_typescript_loader_error){}var viewer_ping_console=__webpack_require__("./node_modules/console-browserify/index.js");const viewer_ping=class ViewerPing{start(){this.stop(),this.timer=setInterval(()=>{!function ping(){try{fetch("/api/ping")}catch(e){viewer_ping_console.error(e)}}()},4e3)}stop(){clearInterval(this.timer)}};var VideoPoster=__webpack_require__("./components/video/VideoPoster/VideoPoster.tsx"),localStorage=__webpack_require__("./utils/localStorage.ts"),ClientConfigStore=__webpack_require__("./components/stores/ClientConfigStore.tsx"),playback_console=__webpack_require__("./node_modules/console-browserify/index.js");const playback=class PlaybackMetrics{stop(){clearInterval(this.sendMetricsTimer),this.player.off()}setClockSkew(skewMs){this.clockSkewMs=skewMs}videoJSReady(){const tech=this.player.tech({IWillNotUseThisInPlugins:!0});this.supportsDetailedMetrics=!!tech,null==tech||tech.on("usage",e=>{"vhs-unknown-waiting"===e.name&&this.setIsBuffering(!0),"vhs-rendition-change-abr"===e.name&&this.incrementQualityVariantChanges()});this.player.textTracks().addEventListener("cuechange",()=>{this.incrementQualityVariantChanges()})}handlePlaying(){clearInterval(this.collectPlaybackMetricsTimer),this.collectPlaybackMetricsTimer=setInterval(()=>{this.collectPlaybackMetrics()},5e3)}handleEnded(){clearInterval(this.collectPlaybackMetricsTimer)}handleBuffering(){this.incrementErrorCount(1),this.setIsBuffering(!0)}handleNoLongerBuffering(){this.setIsBuffering(!1)}handleError(){this.incrementErrorCount(1)}incrementErrorCount(count){this.errors+=count}incrementQualityVariantChanges(){this.hasPerformedInitialVariantChange?this.qualityVariantChanges++:this.hasPerformedInitialVariantChange=!0}setIsBuffering(isBuffering){this.isBuffering=isBuffering,isBuffering?this.bufferingDurationTimer=setTimeout(()=>{this.incrementErrorCount(1)},500):clearTimeout(this.bufferingDurationTimer)}trackSegmentDownloadTime(seconds){this.segmentDownloadTime.push(seconds)}trackBandwidth(bps){this.bandwidthTracking.push(bps)}trackLatency(latency){this.latencyTracking.push(latency)}collectPlaybackMetrics(){const tech=this.player.tech({IWillNotUseThisInPlugins:!0});if(!tech||!tech.vhs)return;if(this.player.paused())return;if(2!==this.player.networkState())return;const bandwidth=tech.vhs.systemBandwidth;this.trackBandwidth(bandwidth);try{const segment=function getCurrentlyPlayingSegment(tech){const targetMedia=tech.vhs.playlists.media(),snapshotTime=tech.currentTime();let segment;for(let i=0,l=targetMedia.segments.length;i<l;i++)if(snapshotTime<targetMedia.segments[i].end){segment=targetMedia.segments[i];break}return segment||([segment]=targetMedia.segments),segment}(tech);if(!segment||!segment.dateTimeObject)return;const segmentTime=segment.dateTimeObject.getTime(),latency=(new Date).getTime()+this.clockSkewMs-segmentTime;if(latency<0||latency/1e3>=100)return;this.trackLatency(latency)}catch(err){playback_console.warn(err)}}async send(){if(0===this.segmentDownloadTime.length)return;if(!this.player||this.player.paused())return;const errorCount=this.errors;let data;if(this.supportsDetailedMetrics){const average=arr=>arr.reduce((p,c)=>p+c,0)/arr.length,averageDownloadDuration=average(this.segmentDownloadTime)/1e3,roundedAverageDownloadDuration=Math.round(1e3*averageDownloadDuration)/1e3,averageBandwidth=average(this.bandwidthTracking)/1e3,roundedAverageBandwidth=Math.round(1e3*averageBandwidth)/1e3,averageLatency=average(this.latencyTracking)/1e3;data={bandwidth:roundedAverageBandwidth,latency:Math.round(1e3*averageLatency)/1e3,downloadDuration:roundedAverageDownloadDuration,errors:errorCount+(this.isBuffering?1:0),qualityVariantChanges:this.qualityVariantChanges}}else data={errors:errorCount+(this.isBuffering?1:0)};this.errors=0,this.qualityVariantChanges=0,this.segmentDownloadTime=[],this.bandwidthTracking=[],this.latencyTracking=[];const options={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)};try{await fetch("/api/metrics/playback",options)}catch(e){playback_console.error(e)}}constructor(player,videojs){this.player=player,this.supportsDetailedMetrics=!1,this.hasPerformedInitialVariantChange=!1,this.clockSkewMs=0,this.segmentDownloadTime=[],this.bandwidthTracking=[],this.latencyTracking=[],this.errors=0,this.qualityVariantChanges=0,this.isBuffering=!1,this.bufferingDurationTimer=0,this.collectPlaybackMetricsTimer=0,this.videoJSReady=this.videoJSReady.bind(this),this.handlePlaying=this.handlePlaying.bind(this),this.handleBuffering=this.handleBuffering.bind(this),this.handleEnded=this.handleEnded.bind(this),this.handleError=this.handleError.bind(this),this.send=this.send.bind(this),this.collectPlaybackMetrics=this.collectPlaybackMetrics.bind(this),this.handleNoLongerBuffering=this.handleNoLongerBuffering.bind(this),this.sendMetricsTimer=0,this.player.on("canplaythrough",this.handleNoLongerBuffering),this.player.on("error",this.handleError),this.player.on("stalled",this.handleBuffering),this.player.on("waiting",this.handleBuffering),this.player.on("playing",this.handlePlaying),this.player.on("ended",this.handleEnded);const oldVjsXhrCallback=videojs.xhr;videojs.Vhs.xhr=(...args)=>{if(args[0].uri.match(".ts")){const start=new Date,cb=args[1];args[1]=(request,error,response)=>{const delta=(new Date).getTime()-start.getTime();this.trackSegmentDownloadTime(delta),cb(request,error,response)}}return oldVjsXhrCallback(...args)},this.videoJSReady(),this.sendMetricsTimer=setInterval(()=>{this.send()},1e4)}};var settings_menu_console=__webpack_require__("./node_modules/console-browserify/index.js");var latencyCompensator_console=__webpack_require__("./node_modules/console-browserify/index.js");const latencyCompensator=class LatencyCompensator{setClockSkew(skewMs){this.clockSkewMs=skewMs}check(){if((new Date).getTime()-this.startupTime.getTime()<1e4)return;if(this.player.paused())return;if(this.player.seeking())return;if(this.inTimeout)return;if(!this.enabled)return;const tech=this.player.tech({IWillNotUseThisInPlugins:!0});if(!tech||!tech.vhs)return;if(2!==this.player.networkState())return;let totalBuffered=0;try{if(0===tech.vhs.stats.buffered.length)return void this.timeout();tech.vhs.stats.buffered.forEach(buffer=>{totalBuffered+=buffer.end-buffer.start})}catch(e){latencyCompensator_console.error(e)}const currentPlaylistBandwidth=tech.vhs.playlists.media().attributes.BANDWIDTH,bandwidthRatio=tech.vhs.systemBandwidth/currentPlaylistBandwidth;try{const segment=function latencyCompensator_getCurrentlyPlayingSegment(tech){const targetMedia=tech.vhs.playlists.media(),snapshotTime=tech.currentTime();let segment;for(let i=0,l=targetMedia.segments.length;i<l;i++)if(snapshotTime<targetMedia.segments[i].end){segment=targetMedia.segments[i];break}return segment||([segment]=targetMedia.segments),segment}(tech);if(!segment)return;if(bandwidthRatio<1.8&&totalBuffered<6*segment.duration)return void this.timeout();const computedMinLatencyThreshold=Math.max(4e3,1e3*segment.duration*1.8),targetLatencies=this.bufferedAtLatency.concat([computedMinLatencyThreshold]),minLatencyThreshold=targetLatencies.reduce((sum,current)=>sum+current,0)/targetLatencies.length;let maxLatencyThreshold=Math.max(1.4*minLatencyThreshold,Math.min(1e3*segment.duration*2.6,15e3));minLatencyThreshold>=maxLatencyThreshold&&(maxLatencyThreshold=minLatencyThreshold+3e3);const segmentTime=segment.dateTimeObject.getTime(),latency=(new Date).getTime()+this.clockSkewMs-segmentTime;if(this.currentLatency=latency,Math.abs(latency)>8e4)return void this.timeout();if(latency>maxLatencyThreshold){if(this.shouldJumpToLive()&&latency>maxLatencyThreshold+5e3){const jumpAmount=latency/1e3-3*segment.duration,seekPosition=this.player.currentTime()+jumpAmount;latencyCompensator_console.info("latency",latency/1e3,"jumping",jumpAmount,"to live from ",this.player.currentTime()," to ",seekPosition);const availableBufferedTimeEnd=tech.vhs.stats.buffered[0].end;if(seekPosition>tech.vhs.stats.buffered[0].start<availableBufferedTimeEnd)return void this.jump(seekPosition)}let proposedPlaybackRate=.33*bandwidthRatio;proposedPlaybackRate=Math.max(Math.min(proposedPlaybackRate,1.08),1),proposedPlaybackRate>this.playbackRate+.02&&(proposedPlaybackRate=this.playbackRate+.02),proposedPlaybackRate=Math.round(1e3*proposedPlaybackRate)/1e3,this.start(proposedPlaybackRate)}else latency<=minLatencyThreshold&&this.stop();latencyCompensator_console.info("latency",latency/1e3,"min",minLatencyThreshold/1e3,"max",maxLatencyThreshold/1e3,"playback rate",this.playbackRate,"enabled:",this.enabled,"running: ",this.running,"skew: ",this.clockSkewMs,"rebuffer events: ",this.bufferingCounter)}catch(e){}}shouldJumpToLive(){if(this.bufferingCounter>1)return!1;return(new Date).getTime()-this.lastJumpOccurred>2e4}jump(seekPosition){this.jumpingToLiveIgnoreBuffer=!0,this.performedInitialLiveJump=!0,this.lastJumpOccurred=new Date,latencyCompensator_console.info("current time",this.player.currentTime(),"seeking to",seekPosition),this.player.currentTime(seekPosition),setTimeout(()=>{this.jumpingToLiveIgnoreBuffer=!1},5e3)}setPlaybackRate(rate){this.playbackRate=rate,this.player.playbackRate(rate)}start(rate=1){!this.inTimeout&&this.enabled&&rate!==this.playbackRate&&(this.running=!0,this.setPlaybackRate(rate))}stop(){this.running&&latencyCompensator_console.log("stopping latency compensator..."),this.running=!1,this.setPlaybackRate(1)}enable(){this.enabled=!0,clearInterval(this.checkTimer),clearTimeout(this.bufferingTimer),this.checkTimer=setInterval(()=>{this.check()},3e3)}disable(){clearInterval(this.checkTimer),clearTimeout(this.timeoutTimer),this.stop(),this.enabled=!1}timeout(){this.jumpingToLiveIgnoreBuffer||(this.inTimeout=!0,this.stop(),clearTimeout(this.timeoutTimer),this.timeoutTimer=setTimeout(()=>{this.endTimeout()},3e4))}endTimeout(){clearTimeout(this.timeoutTimer),this.inTimeout=!1}handlePlaying(){const wasPreviouslyPlaying=this.playing;this.playing=!0,clearTimeout(this.bufferingTimer),this.enabled&&this.shouldJumpToLive()&&(wasPreviouslyPlaying||(this.jumpingToLiveIgnoreBuffer=!0,this.player.liveTracker.seekToLiveEdge(),this.lastJumpOccurred=new Date))}handlePause(){this.playing=!1}handleEnded(){this.enabled&&this.disable()}handleError(){this.enabled&&this.timeout()}countBufferingEvent(){this.bufferingCounter+=1,this.bufferingCounter>4?this.disable():(this.bufferedAtLatency.push(this.currentLatency),latencyCompensator_console.log("latency compensation timeout due to buffering:",this.bufferingCounter,"buffering events of",4),setTimeout(()=>{this.bufferingCounter>0&&(this.bufferingCounter-=1)},18e4))}handleBuffering(){this.enabled&&!this.inTimeout&&(this.jumpingToLiveIgnoreBuffer?this.jumpingToLiveIgnoreBuffer=!1:(this.timeout(),clearTimeout(this.bufferingTimer),this.bufferingTimer=setTimeout(()=>{this.countBufferingEvent()},200)))}constructor(player){this.player=player,this.playing=!1,this.enabled=!1,this.running=!1,this.inTimeout=!1,this.jumpingToLiveIgnoreBuffer=!1,this.timeoutTimer=0,this.checkTimer=0,this.bufferingCounter=0,this.bufferingTimer=0,this.playbackRate=1,this.lastJumpOccurred=null,this.startupTime=new Date,this.clockSkewMs=0,this.currentLatency=null,this.bufferedAtLatency=[],this.player.on("playing",this.handlePlaying.bind(this)),this.player.on("pause",this.handlePause.bind(this)),this.player.on("error",this.handleError.bind(this)),this.player.on("waiting",this.handleBuffering.bind(this)),this.player.on("stalled",this.handleBuffering.bind(this)),this.player.on("ended",this.handleEnded.bind(this)),this.player.on("canplaythrough",this.handlePlaying.bind(this)),this.player.on("canplay",this.handlePlaying.bind(this)),this.check=this.check.bind(this),this.start=this.start.bind(this),this.enable=this.enable.bind(this),this.countBufferingEvent=this.countBufferingEvent.bind(this)}};var OwncastPlayer_module=__webpack_require__("./node_modules/@storybook/nextjs/node_modules/css-loader/dist/cjs.js??ruleSet[1].rules[15].use[1]!./node_modules/postcss-loader/dist/cjs.js!./node_modules/resolve-url-loader/index.js!./node_modules/sass-loader/dist/cjs.js??ruleSet[1].rules[15].use[4]!./components/video/OwncastPlayer/OwncastPlayer.module.scss"),OwncastPlayer_module_options={};OwncastPlayer_module_options.styleTagTransform=styleTagTransform_default(),OwncastPlayer_module_options.setAttributes=setAttributesWithoutAttributes_default(),OwncastPlayer_module_options.insert=insertBySelector_default().bind(null,"head"),OwncastPlayer_module_options.domAPI=styleDomAPI_default(),OwncastPlayer_module_options.insertStyleElement=insertStyleElement_default();injectStylesIntoStyleTag_default()(OwncastPlayer_module.A,OwncastPlayer_module_options);const OwncastPlayer_OwncastPlayer_module=OwncastPlayer_module.A&&OwncastPlayer_module.A.locals?OwncastPlayer_module.A.locals:void 0;var video_settings_service=__webpack_require__("./services/video-settings-service.ts"),ComponentError=__webpack_require__("./components/ui/ComponentError/ComponentError.tsx"),OwncastPlayer_console=__webpack_require__("./node_modules/console-browserify/index.js");const OwncastPlayer_ping=new viewer_ping;let playbackMetrics=null,OwncastPlayer_latencyCompensator=null,latencyCompensatorEnabled=!1;const OwncastPlayer=({source,online,initiallyMuted=!1,title,className})=>{const VideoSettingsService=(0,react.useContext)(video_settings_service.L),playerRef=react.useRef(null),[videoPlaying,setVideoPlaying]=(0,es.L4)(ClientConfigStore.Fb),clockSkew=(0,es.vc)(ClientConfigStore.uL),handleVolume=()=>{(0,localStorage.ZB)("owncast_volume",playerRef.current.muted()?0:playerRef.current.volume())},startLatencyCompensator=()=>{OwncastPlayer_latencyCompensator&&OwncastPlayer_latencyCompensator.stop(),latencyCompensatorEnabled=!0,OwncastPlayer_latencyCompensator=new latencyCompensator(playerRef.current),OwncastPlayer_latencyCompensator.setClockSkew(clockSkew),OwncastPlayer_latencyCompensator.enable(),(0,localStorage.ZB)("latencyCompensatorEnabled",!0)},stopLatencyCompensator=()=>{OwncastPlayer_latencyCompensator&&OwncastPlayer_latencyCompensator.disable(),OwncastPlayer_latencyCompensator=null,latencyCompensatorEnabled=!1,(0,localStorage.ZB)("latencyCompensatorEnabled",!1)},toggleLatencyCompensator=()=>(latencyCompensatorEnabled?stopLatencyCompensator():startLatencyCompensator(),latencyCompensatorEnabled),createSettings=async(player,videojs)=>{const menuButton=function createVideoSettingsMenuButton(player,videojs,qualities,latencyItemPressed){const VjsMenuItem=videojs.getComponent("MenuItem"),MenuItem=videojs.getComponent("MenuItem"),MenuButtonClass=videojs.getComponent("MenuButton"),lowLatencyItem=new MenuItem(player,{selectable:!0,label:"minimize latency (experimental)"});lowLatencyItem.on("click",()=>{const enabled=latencyItemPressed();lowLatencyItem.selected(enabled)}),new class MenuSeparator extends VjsMenuItem{createEl(tag="button",props={},attributes={}){const el=super.createEl(tag,props,attributes);return el.innerHTML='<hr style="opacity: 0.3; margin-left: 10px; margin-right: 10px;" />',el}constructor(p,options){super(p,options)}}(player,{selectable:!1});class MenuButton extends MenuButtonClass{createItems(){const tech=player.tech({IWillNotUseThisInPlugins:!0}),defaultAutoItem=new MenuItem(player,{selectable:!0,selected:!0,label:"Auto"}),items=Array(qualities.length);let clickEvent;qualities.forEach(item=>{items[item.index]=new MenuItem(player,{selectable:!0,label:item.name})}),clickEvent="ontouchstart"in window?"touchend":"click";for(let i=0;i<items.length;i+=1)items[i].on(clickEvent,()=>{tech?(tech.vhs.representations().forEach((rep,index)=>{const isCurrent=index===i;rep.enabled(isCurrent),items[index].selected(isCurrent)}),defaultAutoItem.selected(!1)):settings_menu_console.warn("Invalid attempt to access null player tech")});return defaultAutoItem.on(clickEvent,()=>{tech.vhs.representations().forEach(rep=>{rep.enabled(!0)}),items.forEach(item=>item.selected(!1)),defaultAutoItem.selected(!0)}),qualities.length,qualities.length,1===qualities.length?[]:[defaultAutoItem,...items]}constructor(){super(player)}}const menuButton=new MenuButton;return menuButton.el().setAttribute("aria-label","Settings"),menuButton.addClass("vjs-quality-selector"),videojs.registerComponent("MenuButton",MenuButton),menuButton}(player,videojs,await VideoSettingsService.getVideoQualities(),toggleLatencyCompensator);player.controlBar.addChild(menuButton,{},player.controlBar.children_.length-2),(player=>{const tech=player.tech({IWillNotUseThisInPlugins:!0});if(!tech||!tech.vhs)return;"true"===(0,localStorage.Lg)("latencyCompensatorEnabled")&&tech&&tech.vhs?startLatencyCompensator():stopLatencyCompensator()})(player)},setupAirplay=(player,videojs)=>{if(window.hasOwnProperty("WebKitPlaybackTargetAvailabilityEvent")){const VJSButtonClass=videojs.getComponent("Button");class ConcreteButtonClass extends VJSButtonClass{handleClick(){try{document.getElementsByTagName("video")[0].webkitShowPlaybackTargetPicker()}catch(e){OwncastPlayer_console.error(e)}}constructor(){super(player)}}const ccbc=new ConcreteButtonClass;player.controlBar.addChild(ccbc).addClass("vjs-airplay")}};(0,dist.vC)("space",e=>{e.preventDefault(),playerRef.current.paused()?playerRef.current.play():playerRef.current.pause()}),(0,dist.vC)("f",()=>{playerRef.current.isFullscreen()?playerRef.current.exitFullscreen():playerRef.current.requestFullscreen()},{enableOnContentEditable:!1}),(0,dist.vC)("m",()=>{playerRef.current.muted()||0===playerRef.current.volume()?playerRef.current.volume(.7):playerRef.current.volume(0)},{enableOnContentEditable:!1}),(0,dist.vC)("0",()=>playerRef.current.volume(playerRef.current.volume()+.1),{enableOnContentEditable:!1}),(0,dist.vC)("9",()=>playerRef.current.volume(playerRef.current.volume()-.1),{enableOnContentEditable:!1});const videoJsOptions={autoplay:!1,controls:!0,responsive:!0,fluid:!1,fill:!0,playsinline:!0,liveui:!0,preload:"auto",muted:initiallyMuted,controlBar:{progressControl:{seekBar:!1}},html5:{vhs:{enableLowInitialPlaylist:!0,experimentalBufferBasedABR:!0,useNetworkInformationApi:!0,maxPlaylistRetries:30}},liveTracker:{trackingThreshold:0,liveTolerance:15},sources:[{src:source,type:"application/x-mpegURL"}]};return(0,react.useEffect)(()=>{playbackMetrics&&playbackMetrics.setClockSkew(clockSkew)},[clockSkew]),(0,react.useEffect)(()=>()=>{stopLatencyCompensator(),null==playbackMetrics||playbackMetrics.stop()},[]),(0,jsx_runtime.jsx)(react_error_boundary_esm.tH,{fallbackRender:({error,resetErrorBoundary})=>(0,jsx_runtime.jsx)(ComponentError.O,{componentName:"OwncastPlayer",message:error.message,retryFunction:resetErrorBoundary}),children:(0,jsx_runtime.jsxs)("div",{className:classnames_default()(OwncastPlayer_OwncastPlayer_module.container,className),id:"player",children:[online&&(0,jsx_runtime.jsx)("div",{className:OwncastPlayer_OwncastPlayer_module.player,children:(0,jsx_runtime.jsx)(VideoJS,{options:videoJsOptions,onReady:(player,videojs)=>{playerRef.current=player,(()=>{try{playerRef.current.volume((0,localStorage.Lg)("owncast_volume")||1)}catch(err){OwncastPlayer_console.warn(err)}})(),setupAirplay(player,videojs),player.on("waiting",()=>{OwncastPlayer_console.debug("player is waiting")}),player.on("dispose",()=>{OwncastPlayer_console.debug("player will dispose"),OwncastPlayer_ping.stop()}),player.on("playing",()=>{OwncastPlayer_console.debug("player is playing"),OwncastPlayer_ping.start(),setVideoPlaying(!0)}),player.on("pause",()=>{OwncastPlayer_console.debug("player is paused"),OwncastPlayer_ping.stop(),setVideoPlaying(!1)}),player.on("ended",()=>{OwncastPlayer_console.debug("player is ended"),OwncastPlayer_ping.stop(),setVideoPlaying(!1)}),videojs.hookOnce(),player.on("volumechange",handleVolume),playbackMetrics=new playback(player,videojs),playbackMetrics.setClockSkew(clockSkew),createSettings(player,videojs)},"aria-label":title})}),(0,jsx_runtime.jsx)("div",{className:OwncastPlayer_OwncastPlayer_module.poster,children:!videoPlaying&&(0,jsx_runtime.jsx)(VideoPoster.v,{online,initialSrc:"/thumbnail.jpg",src:"/thumbnail.jpg"})})]})})};try{OwncastPlayer.displayName="OwncastPlayer",OwncastPlayer.__docgenInfo={description:"",displayName:"OwncastPlayer",props:{source:{defaultValue:null,description:"",name:"source",required:!0,type:{name:"string"}},online:{defaultValue:null,description:"",name:"online",required:!0,type:{name:"boolean"}},initiallyMuted:{defaultValue:{value:"false"},description:"",name:"initiallyMuted",required:!1,type:{name:"boolean"}},title:{defaultValue:null,description:"",name:"title",required:!0,type:{name:"string"}},className:{defaultValue:null,description:"",name:"className",required:!1,type:{name:"string"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["components/video/OwncastPlayer/OwncastPlayer.tsx#OwncastPlayer"]={docgenInfo:OwncastPlayer.__docgenInfo,name:"OwncastPlayer",path:"components/video/OwncastPlayer/OwncastPlayer.tsx#OwncastPlayer"})}catch(__react_docgen_typescript_loader_error){}},"./components/video/VideoPoster/VideoPoster.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{v:()=>VideoPoster});var jsx_runtime=__webpack_require__("./node_modules/next/dist/compiled/react/jsx-runtime.js"),react=__webpack_require__("./node_modules/next/dist/compiled/react/index.js");const imgStyle={position:"absolute",width:"100%",height:"100%"},CrossfadeImage=({src="",width,height,objectFit="fill",duration="3s",className})=>{const spanStyle=(0,react.useMemo)(()=>({display:"inline-block",position:"relative",width,height}),[width,height]),imgStyles=(0,react.useMemo)(()=>[{...imgStyle,objectFit,opacity:0,transition:`opacity ${duration}`},{...imgStyle,objectFit,opacity:1,transition:`opacity ${duration}`},{...imgStyle,objectFit,opacity:0}],[objectFit,duration]),[key,setKey]=(0,react.useState)(0),[srcs,setSrcs]=(0,react.useState)(["",""]),nextSrc=src!==srcs[1]?src:"",onLoadImg=()=>{setKey((key+1)%3),setSrcs([srcs[1],nextSrc])};return(0,jsx_runtime.jsx)("span",{style:spanStyle,className,children:[...srcs,nextSrc].map((singleSrc,index)=>""!==singleSrc&&(0,jsx_runtime.jsx)("img",{src:singleSrc,alt:"",style:imgStyles[index],onLoad:2===index?onLoadImg:void 0},singleSrc))})};try{CrossfadeImage.displayName="CrossfadeImage",CrossfadeImage.__docgenInfo={description:"",displayName:"CrossfadeImage",props:{src:{defaultValue:{value:""},description:"",name:"src",required:!1,type:{name:"string"}},width:{defaultValue:null,description:"",name:"width",required:!0,type:{name:"string"}},height:{defaultValue:null,description:"",name:"height",required:!0,type:{name:"string"}},objectFit:{defaultValue:{value:"fill"},description:"",name:"objectFit",required:!1,type:{name:"enum",value:[{value:'"fill"'},{value:'"-moz-initial"'},{value:'"inherit"'},{value:'"initial"'},{value:'"revert"'},{value:'"revert-layer"'},{value:'"unset"'},{value:'"contain"'},{value:'"cover"'},{value:'"none"'},{value:'"scale-down"'}]}},duration:{defaultValue:{value:"3s"},description:"",name:"duration",required:!1,type:{name:"string"}},className:{defaultValue:null,description:"",name:"className",required:!1,type:{name:"string"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["components/ui/CrossfadeImage/CrossfadeImage.tsx#CrossfadeImage"]={docgenInfo:CrossfadeImage.__docgenInfo,name:"CrossfadeImage",path:"components/ui/CrossfadeImage/CrossfadeImage.tsx#CrossfadeImage"})}catch(__react_docgen_typescript_loader_error){}var injectStylesIntoStyleTag=__webpack_require__("./node_modules/@storybook/nextjs/node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js"),injectStylesIntoStyleTag_default=__webpack_require__.n(injectStylesIntoStyleTag),styleDomAPI=__webpack_require__("./node_modules/@storybook/nextjs/node_modules/style-loader/dist/runtime/styleDomAPI.js"),styleDomAPI_default=__webpack_require__.n(styleDomAPI),insertBySelector=__webpack_require__("./node_modules/@storybook/nextjs/node_modules/style-loader/dist/runtime/insertBySelector.js"),insertBySelector_default=__webpack_require__.n(insertBySelector),setAttributesWithoutAttributes=__webpack_require__("./node_modules/@storybook/nextjs/node_modules/style-loader/dist/runtime/setAttributesWithoutAttributes.js"),setAttributesWithoutAttributes_default=__webpack_require__.n(setAttributesWithoutAttributes),insertStyleElement=__webpack_require__("./node_modules/@storybook/nextjs/node_modules/style-loader/dist/runtime/insertStyleElement.js"),insertStyleElement_default=__webpack_require__.n(insertStyleElement),styleTagTransform=__webpack_require__("./node_modules/@storybook/nextjs/node_modules/style-loader/dist/runtime/styleTagTransform.js"),styleTagTransform_default=__webpack_require__.n(styleTagTransform),VideoPoster_module=__webpack_require__("./node_modules/@storybook/nextjs/node_modules/css-loader/dist/cjs.js??ruleSet[1].rules[15].use[1]!./node_modules/postcss-loader/dist/cjs.js!./node_modules/resolve-url-loader/index.js!./node_modules/sass-loader/dist/cjs.js??ruleSet[1].rules[15].use[4]!./components/video/VideoPoster/VideoPoster.module.scss"),options={};options.styleTagTransform=styleTagTransform_default(),options.setAttributes=setAttributesWithoutAttributes_default(),options.insert=insertBySelector_default().bind(null,"head"),options.domAPI=styleDomAPI_default(),options.insertStyleElement=insertStyleElement_default();injectStylesIntoStyleTag_default()(VideoPoster_module.A,options);const VideoPoster_VideoPoster_module=VideoPoster_module.A&&VideoPoster_module.A.locals?VideoPoster_module.A.locals:void 0,VideoPoster=({online,initialSrc,src:base})=>{let timer;const[src,setSrc]=(0,react.useState)(initialSrc),[duration,setDuration]=(0,react.useState)("0s");return(0,react.useEffect)(()=>{clearInterval(timer),timer=setInterval(()=>{"0s"===duration&&setDuration("3s"),setSrc(`${base}?${Date.now()}`)},2e4)},[]),(0,jsx_runtime.jsxs)("div",{className:VideoPoster_VideoPoster_module.poster,children:[!online&&(0,jsx_runtime.jsx)("img",{src:initialSrc,alt:"logo"}),online&&(0,jsx_runtime.jsx)(CrossfadeImage,{src,duration,objectFit:"contain",height:"auto",width:"100%",className:VideoPoster_VideoPoster_module.image})]})};try{VideoPoster.displayName="VideoPoster",VideoPoster.__docgenInfo={description:"",displayName:"VideoPoster",props:{initialSrc:{defaultValue:null,description:"",name:"initialSrc",required:!0,type:{name:"string"}},src:{defaultValue:null,description:"",name:"src",required:!0,type:{name:"string"}},online:{defaultValue:null,description:"",name:"online",required:!0,type:{name:"boolean"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["components/video/VideoPoster/VideoPoster.tsx#VideoPoster"]={docgenInfo:VideoPoster.__docgenInfo,name:"VideoPoster",path:"components/video/VideoPoster/VideoPoster.tsx#VideoPoster"})}catch(__react_docgen_typescript_loader_error){}},"./node_modules/@storybook/nextjs/node_modules/css-loader/dist/cjs.js??ruleSet[1].rules[15].use[1]!./node_modules/postcss-loader/dist/cjs.js!./node_modules/resolve-url-loader/index.js!./node_modules/sass-loader/dist/cjs.js??ruleSet[1].rules[15].use[4]!./components/video/OwncastPlayer/OwncastPlayer.module.scss":(module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{A:()=>__WEBPACK_DEFAULT_EXPORT__});var _node_modules_storybook_nextjs_node_modules_css_loader_dist_runtime_sourceMaps_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/@storybook/nextjs/node_modules/css-loader/dist/runtime/sourceMaps.js"),_node_modules_storybook_nextjs_node_modules_css_loader_dist_runtime_sourceMaps_js__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(_node_modules_storybook_nextjs_node_modules_css_loader_dist_runtime_sourceMaps_js__WEBPACK_IMPORTED_MODULE_0__),_node_modules_storybook_nextjs_node_modules_css_loader_dist_runtime_api_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/@storybook/nextjs/node_modules/css-loader/dist/runtime/api.js"),___CSS_LOADER_EXPORT___=__webpack_require__.n(_node_modules_storybook_nextjs_node_modules_css_loader_dist_runtime_api_js__WEBPACK_IMPORTED_MODULE_1__)()(_node_modules_storybook_nextjs_node_modules_css_loader_dist_runtime_sourceMaps_js__WEBPACK_IMPORTED_MODULE_0___default());___CSS_LOADER_EXPORT___.push([module.id,".OwncastPlayer_container__CR5Ry{display:grid;width:100%;justify-items:center;height:var(--player-container-height);aspect-ratio:16/9}@media(width <= 1200px){.OwncastPlayer_container__CR5Ry{height:100%;max-height:var(--player-container-height)}}@media only screen and (width <= 768px){.OwncastPlayer_container__CR5Ry{height:var(--player-container-height);max-height:var(--player-container-height)}}.OwncastPlayer_container__CR5Ry .OwncastPlayer_player__dCDjy,.OwncastPlayer_container__CR5Ry .OwncastPlayer_poster__tbpwE{width:100%;grid-column:1;grid-row:1}","",{version:3,sources:["webpack://./components/video/OwncastPlayer/OwncastPlayer.module.scss","webpack://./styles/mixins.scss"],names:[],mappings:"AAEA,gCACE,YAAA,CACA,UAAA,CACA,oBAAA,CACA,qCAAA,CACA,iBAAA,CAEA,wBAPF,gCAQI,WAAA,CACA,yCAAA,CAAA,CCIA,wCDbJ,gCAmBI,qCAAA,CACA,yCAAA,CAAA,CAGF,0HAEE,UAAA,CACA,aAAA,CACA,UAAA",sourcesContent:["@use '../../../styles/mixins' as *;\n\n.container {\n  display: grid;\n  width: 100%;\n  justify-items: center;\n  height: var(--player-container-height);\n  aspect-ratio: 16 / 9;\n\n  @media (width <= 1200px) {\n    height: 100%;\n    max-height: var(--player-container-height);\n  }\n\n  @include screen(desktop) {\n    // prevent sidebar from overlapping stream\n    // padding-right: 320px;\n  }\n\n  // set height of player for tablet\n  @include screen(tablet) {\n    height: var(--player-container-height);\n    max-height: var(--player-container-height);\n  }\n\n  .player,\n  .poster {\n    width: 100%;\n    grid-column: 1;\n    grid-row: 1;\n  }\n}\n","@mixin flex-center {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n}\n\n@mixin screen($breakpoint) {\n  @if $breakpoint == desktop {\n    @media only screen and (width >= 768px) {\n      @content;\n    }\n  }\n\n  // tablet will also apply to mobile as there is no cut-off for min-width, however changing this now could break CSS all over the site.\n  @if $breakpoint == tablet {\n    @media only screen and (width <= 768px) {\n      @content;\n    }\n  }\n\n  @if $breakpoint == mobile {\n    @media only screen and (width <= 481px) {\n      @content;\n    }\n  }\n}\n"],sourceRoot:""}]),___CSS_LOADER_EXPORT___.locals={container:"OwncastPlayer_container__CR5Ry",player:"OwncastPlayer_player__dCDjy",poster:"OwncastPlayer_poster__tbpwE"};const __WEBPACK_DEFAULT_EXPORT__=___CSS_LOADER_EXPORT___},"./node_modules/@storybook/nextjs/node_modules/css-loader/dist/cjs.js??ruleSet[1].rules[15].use[1]!./node_modules/postcss-loader/dist/cjs.js!./node_modules/resolve-url-loader/index.js!./node_modules/sass-loader/dist/cjs.js??ruleSet[1].rules[15].use[4]!./components/video/VideoJS/VideoJS.module.scss":(module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{A:()=>__WEBPACK_DEFAULT_EXPORT__});var _node_modules_storybook_nextjs_node_modules_css_loader_dist_runtime_sourceMaps_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/@storybook/nextjs/node_modules/css-loader/dist/runtime/sourceMaps.js"),_node_modules_storybook_nextjs_node_modules_css_loader_dist_runtime_sourceMaps_js__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(_node_modules_storybook_nextjs_node_modules_css_loader_dist_runtime_sourceMaps_js__WEBPACK_IMPORTED_MODULE_0__),_node_modules_storybook_nextjs_node_modules_css_loader_dist_runtime_api_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/@storybook/nextjs/node_modules/css-loader/dist/runtime/api.js"),___CSS_LOADER_EXPORT___=__webpack_require__.n(_node_modules_storybook_nextjs_node_modules_css_loader_dist_runtime_api_js__WEBPACK_IMPORTED_MODULE_1__)()(_node_modules_storybook_nextjs_node_modules_css_loader_dist_runtime_sourceMaps_js__WEBPACK_IMPORTED_MODULE_0___default());___CSS_LOADER_EXPORT___.push([module.id,".VideoJS_player__GD36e{width:100%}","",{version:3,sources:["webpack://./components/video/VideoJS/VideoJS.module.scss"],names:[],mappings:"AAEA,uBACE,UAAA",sourcesContent:["@use '../../../styles/mixins' as *;\n\n.player {\n  width: 100%;\n}\n"],sourceRoot:""}]),___CSS_LOADER_EXPORT___.locals={player:"VideoJS_player__GD36e"};const __WEBPACK_DEFAULT_EXPORT__=___CSS_LOADER_EXPORT___},"./node_modules/@storybook/nextjs/node_modules/css-loader/dist/cjs.js??ruleSet[1].rules[15].use[1]!./node_modules/postcss-loader/dist/cjs.js!./node_modules/resolve-url-loader/index.js!./node_modules/sass-loader/dist/cjs.js??ruleSet[1].rules[15].use[4]!./components/video/VideoPoster/VideoPoster.module.scss":(module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{A:()=>__WEBPACK_DEFAULT_EXPORT__});var _node_modules_storybook_nextjs_node_modules_css_loader_dist_runtime_sourceMaps_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/@storybook/nextjs/node_modules/css-loader/dist/runtime/sourceMaps.js"),_node_modules_storybook_nextjs_node_modules_css_loader_dist_runtime_sourceMaps_js__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(_node_modules_storybook_nextjs_node_modules_css_loader_dist_runtime_sourceMaps_js__WEBPACK_IMPORTED_MODULE_0__),_node_modules_storybook_nextjs_node_modules_css_loader_dist_runtime_api_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/@storybook/nextjs/node_modules/css-loader/dist/runtime/api.js"),___CSS_LOADER_EXPORT___=__webpack_require__.n(_node_modules_storybook_nextjs_node_modules_css_loader_dist_runtime_api_js__WEBPACK_IMPORTED_MODULE_1__)()(_node_modules_storybook_nextjs_node_modules_css_loader_dist_runtime_sourceMaps_js__WEBPACK_IMPORTED_MODULE_0___default());___CSS_LOADER_EXPORT___.push([module.id,".VideoPoster_poster__6rnLj{display:flex;justify-content:center;width:100%;height:100%}.VideoPoster_image__8kRcw{background-color:#000}","",{version:3,sources:["webpack://./components/video/VideoPoster/VideoPoster.module.scss"],names:[],mappings:"AAAA,2BACE,YAAA,CACA,sBAAA,CACA,UAAA,CACA,WAAA,CAGF,0BACE,qBAAA",sourcesContent:[".poster {\n  display: flex;\n  justify-content: center;\n  width: 100%;\n  height: 100%;\n}\n\n.image {\n  background-color: black;\n}\n"],sourceRoot:""}]),___CSS_LOADER_EXPORT___.locals={poster:"VideoPoster_poster__6rnLj",image:"VideoPoster_image__8kRcw"};const __WEBPACK_DEFAULT_EXPORT__=___CSS_LOADER_EXPORT___},"?34aa":()=>{}}]);